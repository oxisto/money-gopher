package graph

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.61

import (
	"context"
	"fmt"
	"slices"
	"time"

	"github.com/oxisto/money-gopher/finance"
	"github.com/oxisto/money-gopher/models"
	"github.com/oxisto/money-gopher/persistence"
)

// Security is the resolver for the security field.
func (r *listedSecurityResolver) Security(ctx context.Context, obj *persistence.ListedSecurity) (*persistence.Security, error) {
	panic(fmt.Errorf("not implemented: Security - security"))
}

// LatestQuoteTimestamp is the resolver for the latestQuoteTimestamp field.
func (r *listedSecurityResolver) LatestQuoteTimestamp(ctx context.Context, obj *persistence.ListedSecurity) (*string, error) {
	panic(fmt.Errorf("not implemented: LatestQuoteTimestamp - latestQuoteTimestamp"))
}

// CreateSecurity is the resolver for the createSecurity field.
func (r *mutationResolver) CreateSecurity(ctx context.Context, input models.SecurityInput) (*persistence.Security, error) {
	return withTx(r.Resolver, func(qtx *persistence.Queries) (*persistence.Security, error) {
		sec, err := qtx.CreateSecurity(ctx, persistence.CreateSecurityParams{
			ID:          input.ID,
			DisplayName: input.DisplayName,
		})
		if err != nil {
			return nil, err
		}

		for _, listed := range input.ListedAs {
			_, err = qtx.UpsertListedSecurity(ctx, persistence.UpsertListedSecurityParams{
				SecurityID: sec.ID,
				Ticker:     listed.Ticker,
				Currency:   listed.Currency,
			})
			if err != nil {
				return nil, err
			}
		}

		return sec, nil
	})
}

// UpdateSecurity is the resolver for the updateSecurity field.
func (r *mutationResolver) UpdateSecurity(ctx context.Context, id string, input models.SecurityInput) (*persistence.Security, error) {
	return withTx(r.Resolver, func(qtx *persistence.Queries) (*persistence.Security, error) {
		sec, err := qtx.UpdateSecurity(ctx, persistence.UpdateSecurityParams{
			ID:          id,
			DisplayName: input.DisplayName,
		})
		if err != nil {
			return nil, err
		}

		// Retrieve old listed securities
		oldListed, err := qtx.ListListedSecuritiesBySecurityID(ctx, id)
		if err != nil {
			return nil, err
		}

		// Upsert the new listed securities
		for _, listed := range input.ListedAs {
			_, err = qtx.UpsertListedSecurity(ctx, persistence.UpsertListedSecurityParams{
				SecurityID: sec.ID,
				Ticker:     listed.Ticker,
				Currency:   listed.Currency,
			})
			if err != nil {
				return nil, err
			}

			// Remove the listed security from the old list
			oldListed = slices.DeleteFunc(oldListed, func(ls *persistence.ListedSecurity) bool {
				return ls.Ticker == listed.Ticker
			})
		}

		// Remove the old listed securities
		for _, old := range oldListed {
			_, err = qtx.DeleteListedSecurity(ctx, persistence.DeleteListedSecurityParams{
				SecurityID: sec.ID,
				Ticker:     old.Ticker,
			})
			if err != nil {
				return nil, err
			}
		}

		return sec, nil
	})
}

// CreatePortfolio is the resolver for the createPortfolio field.
func (r *mutationResolver) CreatePortfolio(ctx context.Context, input models.PortfolioInput) (*persistence.Portfolio, error) {
	panic(fmt.Errorf("not implemented: CreatePortfolio - createPortfolio"))
}

// TriggerQuoteUpdate is the resolver for the triggerQuoteUpdate field.
func (r *mutationResolver) TriggerQuoteUpdate(ctx context.Context, securityIDs []string) (updated []*persistence.ListedSecurity, err error) {
	updated, err = r.QuoteUpdater.UpdateQuotes(ctx, securityIDs)
	if err != nil {
		return nil, err
	}

	return
}

// BankAccount is the resolver for the bankAccount field.
func (r *portfolioResolver) BankAccount(ctx context.Context, obj *persistence.Portfolio) (*persistence.BankAccount, error) {
	return r.DB.GetBankAccount(ctx, obj.BankAccountID)
}

// Snapshot is the resolver for the snapshot field.
func (r *portfolioResolver) Snapshot(ctx context.Context, obj *persistence.Portfolio, when string) (snap *models.PortfolioSnapshot, err error) {
	var t time.Time

	if when == "" {
		t = time.Now()
	} else {
		t, err = time.Parse(time.RFC3339, when)
		if err != nil {
			return nil, err
		}
	}

	return finance.BuildSnapshot(ctx, t, obj.ID, r.DB)
}

// Events is the resolver for the events field.
func (r *portfolioResolver) Events(ctx context.Context, obj *persistence.Portfolio) ([]*persistence.PortfolioEvent, error) {
	panic(fmt.Errorf("not implemented: Events - events"))
}

// Time is the resolver for the time field.
func (r *portfolioEventResolver) Time(ctx context.Context, obj *persistence.PortfolioEvent) (string, error) {
	panic(fmt.Errorf("not implemented: Time - time"))
}

// Security is the resolver for the security field.
func (r *portfolioEventResolver) Security(ctx context.Context, obj *persistence.PortfolioEvent) (*persistence.Security, error) {
	panic(fmt.Errorf("not implemented: Security - security"))
}

// Security is the resolver for the security field.
func (r *queryResolver) Security(ctx context.Context, id string) (*persistence.Security, error) {
	return r.DB.GetSecurity(ctx, id)
}

// Securities is the resolver for the securities field.
func (r *queryResolver) Securities(ctx context.Context) ([]*persistence.Security, error) {
	return r.DB.ListSecurities(ctx)
}

// Portfolio is the resolver for the portfolio field.
func (r *queryResolver) Portfolio(ctx context.Context, id string) (*persistence.Portfolio, error) {
	return r.DB.GetPortfolio(ctx, id)
}

// Portfolios is the resolver for the portfolios field.
func (r *queryResolver) Portfolios(ctx context.Context) ([]*persistence.Portfolio, error) {
	return r.DB.ListPortfolios(ctx)
}

// QuoteProvider is the resolver for the quoteProvider field.
func (r *securityResolver) QuoteProvider(ctx context.Context, obj *persistence.Security) (*string, error) {
	if obj.QuoteProvider.Valid {
		return &obj.QuoteProvider.String, nil
	}

	return nil, nil
}

// ListedAs is the resolver for the listedAs field.
func (r *securityResolver) ListedAs(ctx context.Context, obj *persistence.Security) ([]*persistence.ListedSecurity, error) {
	return obj.ListedAs(ctx, r.DB)
}

// ListedSecurity returns ListedSecurityResolver implementation.
func (r *Resolver) ListedSecurity() ListedSecurityResolver { return &listedSecurityResolver{r} }

// Mutation returns MutationResolver implementation.
func (r *Resolver) Mutation() MutationResolver { return &mutationResolver{r} }

// Portfolio returns PortfolioResolver implementation.
func (r *Resolver) Portfolio() PortfolioResolver { return &portfolioResolver{r} }

// PortfolioEvent returns PortfolioEventResolver implementation.
func (r *Resolver) PortfolioEvent() PortfolioEventResolver { return &portfolioEventResolver{r} }

// Query returns QueryResolver implementation.
func (r *Resolver) Query() QueryResolver { return &queryResolver{r} }

// Security returns SecurityResolver implementation.
func (r *Resolver) Security() SecurityResolver { return &securityResolver{r} }

type listedSecurityResolver struct{ *Resolver }
type mutationResolver struct{ *Resolver }
type portfolioResolver struct{ *Resolver }
type portfolioEventResolver struct{ *Resolver }
type queryResolver struct{ *Resolver }
type securityResolver struct{ *Resolver }
